(function(){function H(a){clearSelection();if(A&&!c.hasStarted&&c.settingWalls){let [b,d]=getXYFromCell(a.target),e=c.gameBoard.getCell(b,d);e.start_cell||e.end_cell||e.wall||(e.wall=!0,a.target.classList.add("wall"))}}function B(a=!0){for(let b=0;b<c.gameBoard.cols;b++)for(let d=0;d<c.gameBoard.rows;d++){let e=c.gameBoard.getCell(b,d),g=getCellElem(b,d);e.path=!1;e.wall||(a&&(e.end_cell=!1,g.classList.remove("end")),g.classList.remove("path"),e.visited=!1,e.distance=0,g.textContent="")}}function I(){let a;
for(let b of l.neighbors){let d=c.gameBoard.getCell(b.x,b.y);if(d.end_cell){w("Enemy crashed into you.");return}if(d.path){a=d;break}}l.start_cell=!1;getCellElem(l.x,l.y).classList.remove("start");l.path=!1;a.start_cell=!0;l=a;getCellElem(a.x,a.y).classList.add("start");B(!1);x(p);c.startLocated&&r(l)}function w(a){Array.from(document.getElementsByClassName("laser")).forEach(b=>b.remove());alert(a);c.hasEnded=!0;document.getElementById("reload").classList.remove("notShown")}function J(){m.removeEventListener("click",
C);m.disabled=!0;m.blur();m.classList.add("hidden");document.getElementById("wallMessage").classList.add("notShown");document.getElementById("pause").classList.remove("hidden");document.getElementById("reload").classList.add("notShown");Array.from(document.querySelectorAll(".cell")).forEach(a=>{a.removeEventListener("mouseover",D);a.removeEventListener("mouselout",highlightCellRevert)})}function C(){if(c.startSet&&c.endSet&&!c.hasStarted){clearSelection();J();c.hasStarted=!0;c.settingWalls=!1;x(p);
for(let a=0;a<c.gameBoard.cols;a++)for(let b=0;b<c.gameBoard.rows;b++)getCellElem(a,b).classList.remove("cell_hover");c.startLocated?(r(l),window.focus(),E(),F()):c.startLocated||(document.getElementById("wallMessage").classList.add("hidden"),document.getElementById("noPathMessage").classList.remove("hidden"))}}function K(a){const b=[];"N"===k?(b.push(a.offsetLeft-3.5+a.offsetWidth/2),b.push(a.offsetTop-a.offsetHeight/2)):"S"===k?(b.push(a.offsetLeft-3.5+a.offsetWidth/2),b.push(a.offsetTop+a.offsetHeight/
2)):"E"===k?(b.push(a.offsetLeft+a.offsetWidth),b.push(a.offsetTop)):"W"===k?(b.push(a.offsetLeft-3.5),b.push(a.offsetTop)):"NW"===k?(b.push(a.offsetLeft),b.push(a.offsetTop-a.offsetHeight/2)):"NE"===k?(b.push(a.offsetLeft-3.5+a.offsetWidth),b.push(a.offsetTop-a.offsetHeight/2)):"SW"===k?(b.push(a.offsetLeft),b.push(a.offsetTop+a.offsetHeight/2)):"SE"===k&&(b.push(a.offsetLeft+a.offsetWidth-3.5),b.push(a.offsetTop+a.offsetHeight/2));return b}function G(){const a=document.createElement("div");a.classList.add("laser");
const [b,d]=K(getCellElemFromCell(p));a.style.left=convertToPXs(b);a.style.top=convertToPXs(d);const e=20*dxmap[k],g=20*dymap[k];a.style.transform="rotate("+anglemap[k]+"deg)";t.appendChild(a);for(let h=0;30>h;h++)sleep(25*h).then(()=>{a.style.top=convertToPXs(d-g*h);a.style.left=convertToPXs(b-e*h);colides(a,getCellElemFromCell(l))&&(document.getElementsByClassName("start")[0].classList.remove("start"),w("You shot the enemy tank!"));Array.from(document.getElementsByClassName("wall")).forEach(q=>
{colides(a,q)&&a.remove()});Array.from(document.getElementsByClassName("edge")).forEach(q=>{colides(a,q)&&a.remove()})});sleep(600).then(()=>a.remove())}async function F(){for(;!c.hasEnded&&!c.paused;){var a=c.movementQueue.dequeue();if("undefined"!==typeof a&&null!==a){var b=void 0;a=a.description;for(let d of p.neighbors)if(d.direction===a){b=c.gameBoard.getCell(d.x,d.y);break}"undefined"===typeof b||null===b||b.wall||(b.start_cell?w("You ran into the enemy tank"):(B(),b.end_cell=!0,getCellElemFromCell(b).classList.add("end"),
p=b,x(p),c.startLocated&&r(l),k=a))}b=c.firingQueue.dequeue();"undefined"!==typeof b&&null!==b&&f[" "]&&G();b=y();for(let d of b){if(b="move"===d.type&&u())a:{b=d.description;for(let e of p.neighbors)if(e.direction===b){b=c.gameBoard.getCell(e.x,e.y);if("undefined"===typeof b||null===b)break;if(b.wall)break;b=!0;break a}b=!1}b&&c.movementQueue.enqueue(d);"fire"===d.type&&c.firingQueue.enqueue(d)}await sleep(100)}}async function E(){for(;!c.hasEnded&&!c.paused;)L(),await sleep(c.speed)}function L(){c.speed=
Array.from(document.getElementById("difficulty").options).find(a=>a.selected).value;I()}function r(a){a.path=!0;0!==a.distance&&(a.start_cell||(getCellElem(a.x,a.y).classList.remove("visited"),getCellElem(a.x,a.y).classList.add("path")),r(a.getLowestDistanceNeighbor()))}function x(a){const b=new Queue;a.visited=!0;for(b.enqueue(a);!b.isEmpty();){a=b.dequeue();if(a.start_cell)break;for(let d of a.neighbors.reverse()){let e=c.gameBoard.getCell(d.x,d.y);"NE"===d.direction&&v("N","E",a,"NE")?a.neighbors.splice(a.neighbors.indexOf(d),
1):"SE"===d.direction&&v("S","E",a,"SE")?a.neighbors.splice(a.neighbors.indexOf(d),1):"SW"===d.direction&&v("S","W",a,"SW")?a.neighbors.splice(a.neighbors.indexOf(d),1):"NW"===d.direction&&v("N","W",a,"NW")?a.neighbors.splice(a.neighbors.indexOf(d),1):(e.start_cell&&(c.startLocated=!0),e.distance>a.distance+d.connection_cost&&e.visited&&(e.distance=a.distance+d.connection_cost),e.visited||e.wall||(e.visited=!0,e.distance=a.distance+d.connection_cost,e.wall||b.enqueue(e)))}}}function v(a,b,d,e){let g=
null,h=null,q=null;for(let n of d.neighbors)n.direction===a&&(g=c.gameBoard.getCell(n.x,n.y)),n.direction===b&&(h=c.gameBoard.getCell(n.x,n.y)),n.direction===e&&(q=c.gameBoard.getCell(n.x,n.y));return null===g||null===h||null===q?!1:g.wall&&h.wall?!q.wall:!1}function M(a){c.hasStarted||c.gridBuilt||(a.target.classList.add("hidden"),m.disabled=!1,m.classList.remove("hidden"),a=Array.from(document.getElementById("mapSize").options).find(b=>b.selected).value,c.gameBoard.cols=a,c.gameBoard.rows=a,document.getElementById("mapSizeDropdown").classList.add("hidden"),
N(),c.gridBuilt=!0,document.getElementById("startMessage").classList.remove("hidden"),m.scrollIntoView({behavior:"smooth"}))}function z(a){A=void 0===a.buttons?1===a.which:1===a.buttons}function N(){for(let a=0;a<c.gameBoard.cols;a++){c.gameBoard.push([]);const b=document.createElement("div");b.id="col-"+a;b.classList.add("col");b.draggable=!1;b.ondragstart=function(){return!1};t.appendChild(b);for(let d=0;d<c.gameBoard.rows;d++){const e=new O(a,d,c);c.gameBoard.pushX(a,e);c.gameBoard.getCell(a,d).setNeighbors();
const g=document.createElement("div");g.id=getCellId(a,d);g.classList.add("cell");g.classList.add("cell_hover");0!==a&&a!==c.gameBoard.cols-1&&0!==d&&d!==c.gameBoard.rows-1||g.classList.add("edge");625>c.gameBoard.cols*c.gameBoard.rows?g.classList.add("large_cell"):1600>c.gameBoard.cols*c.gameBoard.rows?g.classList.add("medium_cell"):3600>c.gameBoard.cols*c.gameBoard.rows?g.classList.add("small_cell"):g.classList.add("x-small_cell");b.appendChild(g);g.addEventListener("mouseup",h=>e.handleClick(h));
g.addEventListener("mouseover",D);g.addEventListener("mouseout",highlightCellRevert);g.draggable=!1;g.ondragstart=function(){return!1}}}}function D(a){c.settingStart?a.target.classList.add("startHighlight"):c.settingEnd?a.target.classList.add("endHighlight"):c.settingWalls&&a.target.classList.add("wallHighlight")}function u(){const a=f.ArrowUp||f.w||f.W,b=f.ArrowDown||f.s||f.S,d=f.ArrowLeft||f.a||f.A,e=f.ArrowRight||f.d||f.D,g=f[" "];return a&&b||d&&e||!(a||b||d||e||g)?!1:!0}function y(){const a=
f.ArrowUp||f.w||f.W,b=f.ArrowDown||f.s||f.S,d=f.ArrowLeft||f.a||f.A,e=f.ArrowRight||f.d||f.D,g=f[" "],h=[];a&&d?h.push(new GameEvent("move","NW")):a&&e?h.push(new GameEvent("move","NE")):b&&e?h.push(new GameEvent("move","SE")):b&&d?h.push(new GameEvent("move","SW")):b?h.push(new GameEvent("move","S")):a?h.push(new GameEvent("move","N")):d?h.push(new GameEvent("move","W")):e&&h.push(new GameEvent("move","E"));g&&h.push(new GameEvent("fire","playertank"));return h}function P(a){-1<["Space","ArrowUp",
"ArrowDown","ArrowLeft","ArrowRight"].indexOf(a.code)&&a.preventDefault();if(c.hasStarted&&!c.hasEnded&&(f[a.key]=!0,!c.paused&&u())){" "!==a.key&&c.movementQueue.empty();a=y();for(let b of a)"move"===b.type&&c.movementQueue.enqueue(b)}}function Q(a){-1<["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(a.code)&&a.preventDefault();if(c.hasStarted&&!c.hasEnded&&(f[a.key]=!1,!c.paused)){" "!==a.key?c.movementQueue.empty():" "===a.key&&(G(),c.firingQueue.empty());a=y();for(let b of a)"move"===
b.type&&u()?c.movementQueue.enqueue(b):"fire"===b.type&&u()&&c.firingQueue.enqueue(b)}}function R(){!c.hasEnded&&c.hasStarted&&(c.paused=!c.paused,c.paused?(c.movementQueue.empty(),c.firingQueue.empty(),document.getElementById("reload").classList.remove("notShown")):(E(),F(),document.getElementById("reload").classList.add("notShown")),document.getElementById("pause").textContent=c.paused?"Unpause":"Pause")}const c=new GameSession(150,30,30);let A=!1,l,p,k="N";const t=document.getElementById("gameBoard_UI"),
m=document.getElementById("start");class O{constructor(a,b,d){this.x=a;this.y=b;this.neighbors=[];this.cardinal_neighbors=[];this.end_cell=this.start_cell=this.path=this.wall=!1;this.distance=0;this.visited=!1;this.session=d}setNeighbors(){const a=[-1,0,1];for(let b of a)for(let d of a)if(validPosition(this.x+b,this.y+d,c.gameBoard.cols,c.gameBoard.rows)){if(0===b&&0===d)continue;let e=getCellConnectionDirection(b,d);0===b||0===d?(this.neighbors.push(build_neighbor(this.x+b,this.y+d,1,e)),this.cardinal_neighbors.push(build_neighbor(this.x+
b,this.y+d,1,e))):this.neighbors.push(build_neighbor(this.x+b,this.y+d,Math.sqrt(2),e))}}getLowestDistanceNeighbor(){let a=Infinity,b=null;for(let d of this.neighbors){let e=c.gameBoard.getCell(d.x,d.y);e.distance<a&&e.visited&&!e.wall&&(a=e.distance,b=e)}return b}handleClick(a){if(!c.settingStart||c.hasStarted||c.settingWalls||0!==a.button)if(!c.settingEnd||c.hasStarted||c.settingWalls||0!==a.button)c.settingEnd||c.settingStart||!c.settingWalls||c.hasStarted||2!==a.button||(this.wall=!1,getCellElem(this.x,
this.y).classList.remove("wall"));else for(p=this,this.end_cell=!0,getCellElem(this.x,this.y).classList.add("end"),c.settingEnd=!1,c.endSet=!0,document.getElementById("endMessage").classList.add("hidden"),document.getElementById("wallMessage").classList.remove("hidden"),c.settingWalls=!0,a=0;a<c.gameBoard.cols;a++)for(let b=0;b<c.gameBoard.rows;b++)getCellElem(a,b).addEventListener("mouseover",H);else this.start_cell=!0,getCellElem(this.x,this.y).classList.add("start"),l=this,c.settingStart=!1,c.settingEnd=
!0,c.startSet=!0,document.getElementById("startMessage").classList.add("hidden"),document.getElementById("endMessage").classList.remove("hidden")}}const f={};(function(){m.addEventListener("click",C);document.getElementById("buildGrid").addEventListener("click",M);document.getElementById("pause").addEventListener("click",R);document.body.onmousedown=z;document.body.onmousemove=z;document.body.onmouseup=z;document.addEventListener("keydown",P);document.addEventListener("keyup",Q);m.disabled=!0;document.oncontextmenu=
()=>!1;document.draggable=!1;document.ondragstart=function(){return!1};document.getElementById("difficulty").addEventListener("change",()=>{document.getElementById("difficulty").blur()});t.draggable=!1;t.ondragstart=function(){return!1}})()})();
