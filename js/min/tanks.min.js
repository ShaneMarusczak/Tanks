(function(){function u(a){c.leftMouseButtonOnlyDown=void 0===a.buttons?1===a.which:1===a.buttons}function z(a=!0){for(let b=0;b<c.gameBoard.cols;b++)for(let d=0;d<c.gameBoard.rows;d++){let e=c.gameBoard.getCell(b,d),f=getCellElem(b,d);e.path=!1;e.wall||(a&&(e.end_cell=!1,f.classList.remove("end")),f.classList.remove("path"),e.visited=!1,e.distance=0)}}function G(){let a;for(let b of c.startCell.neighbors){let d=c.gameBoard.getCell(b.x,b.y);if(d.end_cell){p("Enemy crashed into you.");return}if(d.path){a=
d;break}}c.startCell.start_cell=!1;getCellElem(c.startCell.x,c.startCell.y).classList.remove("start");c.startCell.path=!1;a.start_cell=!0;c.startCell=a;getCellElem(a.x,a.y).classList.add("start");z(!1);v(c.endCell);c.startLocated&&q(c.startCell)}function p(a){Array.from(document.getElementsByClassName("laser")).forEach(b=>b.remove());Array.from(document.getElementsByClassName("enemylaser")).forEach(b=>b.remove());alert(a);c.hasEnded=!0;document.getElementById("reload").classList.remove("notShown")}
function H(){l.removeEventListener("click",A);l.disabled=!0;l.blur();l.classList.add("hidden");document.getElementById("wallMessage").classList.add("notShown");w.classList.remove("hidden");document.getElementById("reload").classList.add("notShown");Array.from(document.querySelectorAll(".cell")).forEach(a=>{a.removeEventListener("mouseover",B);a.removeEventListener("mouselout",highlightCellRevert)})}function A(){if(c.startSet&&c.endSet&&!c.hasStarted){clearSelection();H();c.hasStarted=!0;c.settingWalls=
!1;v(c.endCell);for(let a=0;a<c.gameBoard.cols;a++)for(let b=0;b<c.gameBoard.rows;b++)getCellElem(a,b).classList.remove("cell_hover");c.startLocated?(q(c.startCell),window.focus(),C(),D()):c.startLocated||(document.getElementById("wallMessage").classList.add("hidden"),document.getElementById("noPathMessage").classList.remove("hidden"))}}function E(a,b){const d=[];"N"===b?(d.push(a.offsetLeft-3.5+a.offsetWidth/2),d.push(a.offsetTop-a.offsetHeight/2)):"S"===b?(d.push(a.offsetLeft-3.5+a.offsetWidth/
2),d.push(a.offsetTop+a.offsetHeight/2)):"E"===b?(d.push(a.offsetLeft+a.offsetWidth),d.push(a.offsetTop)):"W"===b?(d.push(a.offsetLeft-3.5),d.push(a.offsetTop)):"NW"===b?(d.push(a.offsetLeft),d.push(a.offsetTop-a.offsetHeight/2)):"NE"===b?(d.push(a.offsetLeft-3.5+a.offsetWidth),d.push(a.offsetTop-a.offsetHeight/2)):"SW"===b?(d.push(a.offsetLeft),d.push(a.offsetTop+a.offsetHeight/2)):"SE"===b&&(d.push(a.offsetLeft+a.offsetWidth-3.5),d.push(a.offsetTop+a.offsetHeight/2));return d}function F(){const a=
document.createElement("div");a.classList.add("laser");const [b,d]=E(getCellElemFromCell(c.endCell),c.lastDirectionMoved);a.style.left=convertToPXs(b);a.style.top=convertToPXs(d);const e=20*dxmap[c.lastDirectionMoved],f=20*dymap[c.lastDirectionMoved];a.style.transform="rotate("+anglemap[c.lastDirectionMoved]+"deg)";m.appendChild(a);for(let h=0;30>h;h++)sleep(25*h).then(()=>{a.style.top=convertToPXs(d-f*h);a.style.left=convertToPXs(b-e*h);colides(a,getCellElemFromCell(c.startCell))&&(document.getElementsByClassName("start")[0].classList.remove("start"),
p("You shot the enemy tank!"));Array.from(document.getElementsByClassName("wall")).forEach(n=>{colides(a,n)&&a.remove()});colides(a,m)||a.remove()});sleep(600).then(()=>a.remove())}async function D(){for(;!c.hasEnded&&!c.paused;){var a=c.movementQueue.dequeue();if("undefined"!==typeof a&&null!==a){var b=void 0;a=a.description;for(let d of c.endCell.neighbors)if(d.direction===a){b=c.gameBoard.getCell(d.x,d.y);break}"undefined"===typeof b||null===b||b.wall||(b.start_cell?p("You ran into the enemy tank"):
(z(),b.end_cell=!0,getCellElemFromCell(b).classList.add("end"),c.endCell=b,v(c.endCell),c.startLocated&&q(c.startCell),c.lastDirectionMoved=a))}b=c.firingQueue.dequeue();"undefined"!==typeof b&&null!==b&&g[" "]&&F();b=x();for(let d of b){if(b="move"===d.type&&r())a:{b=d.description;for(let e of c.endCell.neighbors)if(e.direction===b){b=c.gameBoard.getCell(e.x,e.y);if("undefined"===typeof b||null===b)break;if(b.wall)break;b=!0;break a}b=!1}b&&c.movementQueue.enqueue(d);"fire"===d.type&&c.firingQueue.enqueue(d)}await sleep(100)}}
async function C(){for(;!c.hasEnded&&!c.paused;)I(),await sleep(c.speed)}function I(){c.speed=Array.from(document.getElementById("difficulty").options).find(a=>a.selected).value;G();J()}function K(){const a=c.startCell,b=c.endCell;let d="";a.x==b.x&&a.y>b.y?d="N":a.x==b.x&&a.y<b.y?d="S":a.x>b.x&&a.y==b.y?d="W":a.x<b.x&&a.y==b.y?d="E":a.x<b.x&&a.y<b.y?d="SE":a.x>b.x&&a.y>b.y?d="NW":a.x<b.x&&a.y>b.y?d="NE":a.x>b.x&&a.y<b.y&&(d="SW");return d}function L(){var a=c.startCell,b=c.endCell,d=b.x;b=b.y;const e=
c.lastDirectionMoved;"N"===e?b-=3:"S"===e?b+=3:"E"===e?d+=3:"W"===e?d-=3:"NW"===e?(b-=3,d-=3):"NE"===e?(b-=3,d+=3):"SW"===e?(b+=3,d-=3):"SE"===e&&(b+=3,d+=3);a=Math.atan2(a.y-b,a.x-d);for(d=180*a/Math.PI-90;360<=d;)d-=360;for(;0>d;)d+=360;return[d,a]}function J(){const a=document.createElement("div");a.classList.add("enemylaser");const [b,d]=E(getCellElemFromCell(c.startCell),K());a.style.left=convertToPXs(b);a.style.top=convertToPXs(d);const [e,f]=L(),h=25*Math.cos(f),n=25*Math.sin(f);a.style.transform=
"rotate("+e+"deg)";m.appendChild(a);for(let k=0;40>k;k++)sleep(40*k).then(()=>{a.style.top=convertToPXs(d-n*k);a.style.left=convertToPXs(b-h*k);colides(a,getCellElemFromCell(c.endCell))&&(document.getElementsByClassName("start")[0].classList.remove("start"),p("Enemy tank shot you!"));Array.from(document.getElementsByClassName("wall")).forEach(M=>{colides(a,M)&&a.remove()});colides(a,m)||a.remove()});sleep(600).then(()=>a.remove())}function q(a){a.path=!0;0!==a.distance&&(a.start_cell||(getCellElem(a.x,
a.y).classList.remove("visited"),getCellElem(a.x,a.y).classList.add("path")),q(a.getLowestDistanceNeighbor()))}function v(a){const b=new Queue;a.visited=!0;for(b.enqueue(a);!b.isEmpty();){a=b.dequeue();if(a.start_cell)break;for(let d of a.neighbors.reverse()){let e=c.gameBoard.getCell(d.x,d.y);"NE"===d.direction&&t("N","E",a,"NE")?a.neighbors.splice(a.neighbors.indexOf(d),1):"SE"===d.direction&&t("S","E",a,"SE")?a.neighbors.splice(a.neighbors.indexOf(d),1):"SW"===d.direction&&t("S","W",a,"SW")?a.neighbors.splice(a.neighbors.indexOf(d),
1):"NW"===d.direction&&t("N","W",a,"NW")?a.neighbors.splice(a.neighbors.indexOf(d),1):(e.start_cell&&(c.startLocated=!0),e.distance>a.distance+d.connection_cost&&e.visited&&(e.distance=a.distance+d.connection_cost),e.visited||e.wall||(e.visited=!0,e.distance=a.distance+d.connection_cost,e.wall||b.enqueue(e)))}}}function t(a,b,d,e){let f=null,h=null,n=null;for(let k of d.neighbors)k.direction===a&&(f=c.gameBoard.getCell(k.x,k.y)),k.direction===b&&(h=c.gameBoard.getCell(k.x,k.y)),k.direction===e&&(n=
c.gameBoard.getCell(k.x,k.y));return null===f||null===h||null===n?!1:f.wall&&h.wall?!n.wall:!1}function N(a){c.hasStarted||c.gridBuilt||(a.target.classList.add("hidden"),l.disabled=!1,l.classList.remove("hidden"),a=Array.from(document.getElementById("mapSize").options).find(b=>b.selected).value,c.gameBoard.cols=a,c.gameBoard.rows=a,document.getElementById("mapSizeDropdown").classList.add("hidden"),document.getElementsByClassName("controls")[0].classList.add("hidden"),O(),c.gridBuilt=!0,document.getElementById("startMessage").classList.remove("hidden"),
l.scrollIntoView({behavior:"smooth"}),document.getElementById("gameBoardWrapper").classList.add("newClass"))}function O(){for(let a=0;a<c.gameBoard.cols;a++){c.gameBoard.push([]);const b=document.createElement("div");b.id="col-"+a;b.classList.add("col");b.draggable=!1;b.ondragstart=function(){return!1};m.appendChild(b);for(let d=0;d<c.gameBoard.rows;d++){const e=new Cell(a,d,c);c.gameBoard.pushX(a,e);c.gameBoard.getCell(a,d).setNeighbors();const f=document.createElement("div");f.id=getCellId(a,d);
f.classList.add("cell");f.classList.add("cell_hover");625>c.gameBoard.cols*c.gameBoard.rows?f.classList.add("large_cell"):1600>c.gameBoard.cols*c.gameBoard.rows?f.classList.add("medium_cell"):3600>c.gameBoard.cols*c.gameBoard.rows?f.classList.add("small_cell"):f.classList.add("x-small_cell");b.appendChild(f);f.addEventListener("mouseup",h=>e.handleClick(h));f.addEventListener("mouseover",B);f.addEventListener("mouseout",highlightCellRevert);f.draggable=!1;f.ondragstart=function(){return!1}}}}function B(a){c.settingStart?
a.target.classList.add("startHighlight"):c.settingEnd?a.target.classList.add("endHighlight"):c.settingWalls&&a.target.classList.add("wallHighlight")}function r(){const a=g.ArrowUp||g.w||g.W,b=g.ArrowDown||g.s||g.S,d=g.ArrowLeft||g.a||g.A,e=g.ArrowRight||g.d||g.D,f=g[" "];return a&&b||d&&e||!(a||b||d||e||f)?!1:!0}function x(){const a=g.ArrowUp||g.w||g.W,b=g.ArrowDown||g.s||g.S,d=g.ArrowLeft||g.a||g.A,e=g.ArrowRight||g.d||g.D,f=g[" "],h=[];a&&d?h.push(new GameEvent("move","NW")):a&&e?h.push(new GameEvent("move",
"NE")):b&&e?h.push(new GameEvent("move","SE")):b&&d?h.push(new GameEvent("move","SW")):b?h.push(new GameEvent("move","S")):a?h.push(new GameEvent("move","N")):d?h.push(new GameEvent("move","W")):e&&h.push(new GameEvent("move","E"));f&&h.push(new GameEvent("fire","playertank"));return h}function P(a){-1<"Space ArrowUp ArrowDown ArrowLeft ArrowRight M".split(" ").indexOf(a.code)&&a.preventDefault();if(c.hasStarted&&!c.hasEnded&&(g[a.key]=!0,!c.paused&&r())){" "!==a.key&&c.movementQueue.empty();a=x();
for(let b of a)"move"===b.type&&c.movementQueue.enqueue(b)}}function Q(a){-1<"Space ArrowUp ArrowDown ArrowLeft ArrowRight M".split(" ").indexOf(a.code)&&a.preventDefault();if(c.hasStarted&&!c.hasEnded&&(g[a.key]=!1,!c.paused)){" "!==a.key&&"m"!==a.key?c.movementQueue.empty():" "===a.key?(F(),c.firingQueue.empty()):"m"===a.key&&R();a=x();for(let b of a)"move"===b.type&&r()?c.movementQueue.enqueue(b):"fire"===b.type&&r()&&c.firingQueue.enqueue(b)}}async function R(){if(!(!c.hasStarted||c.hasEnded||
c.paused||4<y)){y++;var a=c.endCell,b=getCellElemFromCell(a);b.classList.add("mine");for(var d=0;8>d;){d++;await sleep(125);if(c.hasEnded)break;b.classList.add("mineFlash");await sleep(125);if(c.hasEnded)break;b.classList.remove("mineFlash")}if(c.hasEnded)b.classList.remove("mine"),b.classList.remove("mineFlash");else{for(let e of a.neighbors)d=c.gameBoard.getCell(e.x,e.y),d.start_cell?(document.getElementsByClassName("start")[0].classList.remove("start"),p("You blew up the enemy tank!")):getCellElemFromCell(d).classList.add("mineFlash");
await sleep(125);for(let e of a.neighbors)a=c.gameBoard.getCell(e.x,e.y),getCellElemFromCell(a).classList.remove("mineFlash");b.classList.remove("mine")}y--}}function S(){!c.hasEnded&&c.hasStarted&&(c.paused=!c.paused,c.paused?(c.movementQueue.empty(),c.firingQueue.empty(),document.getElementById("reload").classList.remove("notShown")):(C(),D(),document.getElementById("reload").classList.add("notShown")),w.textContent=c.paused?"Unpause":"Pause")}const c=new GameSession(150,30,30),m=document.getElementById("gameBoard_UI"),
l=document.getElementById("start"),w=document.getElementById("pause"),g={};let y=0;const T=()=>{const a=document.getElementById("ctrlList"),b=document.getElementById("hideBtn");a.classList.contains("hidden")?(a.classList.remove("hidden"),b.textContent="Hide"):(a.classList.add("hidden"),b.textContent="Show")};(function(){l.addEventListener("click",A);document.getElementById("buildGrid").addEventListener("click",N);w.addEventListener("click",S);document.getElementById("hideBtn").addEventListener("click",
T);document.body.onmousedown=u;document.body.onmousemove=u;document.body.onmouseup=u;document.addEventListener("keydown",P);document.addEventListener("keyup",Q);l.disabled=!0;document.oncontextmenu=()=>!1;document.draggable=!1;document.ondragstart=function(){return!1};document.getElementById("difficulty").addEventListener("change",()=>{document.getElementById("difficulty").blur()});m.draggable=!1;m.ondragstart=function(){return!1}})()})();
