(function(){function u(a){b.leftMouseButtonOnlyDown=void 0===a.buttons?1===a.which:1===a.buttons}function z(a=!0){for(let c=0;c<b.gameBoard.cols;c++)for(let d=0;d<b.gameBoard.rows;d++){let e=b.gameBoard.getCell(c,d),g=getCellElem(c,d);e.path=!1;e.wall||(a&&(e.end_cell=!1,g.classList.remove("end")),g.classList.remove("path"),e.visited=!1,e.distance=0)}}function F(){let a;for(let c of b.startCell.neighbors){let d=b.gameBoard.getCell(c.x,c.y);if(d.end_cell){n("Enemy crashed into you.");return}if(d.path){a=
d;break}}b.startCell.start_cell=!1;getCellElem(b.startCell.x,b.startCell.y).classList.remove("start");b.startCell.path=!1;a.start_cell=!0;b.startCell=a;getCellElem(a.x,a.y).classList.add("start");z(!1);v(b.endCell);b.startLocated&&p(b.startCell)}function n(a){Array.from(document.getElementsByClassName("laser")).forEach(c=>c.remove());alert(a);b.hasEnded=!0;document.getElementById("reload").classList.remove("notShown")}function G(){k.removeEventListener("click",A);k.disabled=!0;k.blur();k.classList.add("hidden");
document.getElementById("wallMessage").classList.add("notShown");w.classList.remove("hidden");document.getElementById("reload").classList.add("notShown");Array.from(document.querySelectorAll(".cell")).forEach(a=>{a.removeEventListener("mouseover",B);a.removeEventListener("mouselout",highlightCellRevert)})}function A(){if(b.startSet&&b.endSet&&!b.hasStarted){clearSelection();G();b.hasStarted=!0;b.settingWalls=!1;v(b.endCell);for(let a=0;a<b.gameBoard.cols;a++)for(let c=0;c<b.gameBoard.rows;c++)getCellElem(a,
c).classList.remove("cell_hover");b.startLocated?(p(b.startCell),window.focus(),C(),D()):b.startLocated||(document.getElementById("wallMessage").classList.add("hidden"),document.getElementById("noPathMessage").classList.remove("hidden"))}}function H(a){const c=[];"N"===b.lastDirectionMoved?(c.push(a.offsetLeft-3.5+a.offsetWidth/2),c.push(a.offsetTop-a.offsetHeight/2)):"S"===b.lastDirectionMoved?(c.push(a.offsetLeft-3.5+a.offsetWidth/2),c.push(a.offsetTop+a.offsetHeight/2)):"E"===b.lastDirectionMoved?
(c.push(a.offsetLeft+a.offsetWidth),c.push(a.offsetTop)):"W"===b.lastDirectionMoved?(c.push(a.offsetLeft-3.5),c.push(a.offsetTop)):"NW"===b.lastDirectionMoved?(c.push(a.offsetLeft),c.push(a.offsetTop-a.offsetHeight/2)):"NE"===b.lastDirectionMoved?(c.push(a.offsetLeft-3.5+a.offsetWidth),c.push(a.offsetTop-a.offsetHeight/2)):"SW"===b.lastDirectionMoved?(c.push(a.offsetLeft),c.push(a.offsetTop+a.offsetHeight/2)):"SE"===b.lastDirectionMoved&&(c.push(a.offsetLeft+a.offsetWidth-3.5),c.push(a.offsetTop+
a.offsetHeight/2));return c}function E(){const a=document.createElement("div");a.classList.add("laser");const [c,d]=H(getCellElemFromCell(b.endCell));a.style.left=convertToPXs(c);a.style.top=convertToPXs(d);const e=20*dxmap[b.lastDirectionMoved],g=20*dymap[b.lastDirectionMoved];a.style.transform="rotate("+anglemap[b.lastDirectionMoved]+"deg)";q.appendChild(a);for(let h=0;30>h;h++)sleep(25*h).then(()=>{a.style.top=convertToPXs(d-g*h);a.style.left=convertToPXs(c-e*h);colides(a,getCellElemFromCell(b.startCell))&&
(document.getElementsByClassName("start")[0].classList.remove("start"),n("You shot the enemy tank!"));Array.from(document.getElementsByClassName("wall")).forEach(m=>{colides(a,m)&&a.remove()});Array.from(document.getElementsByClassName("edge")).forEach(m=>{colides(a,m)&&a.remove()})});sleep(600).then(()=>a.remove())}async function D(){for(;!b.hasEnded&&!b.paused;){var a=b.movementQueue.dequeue();if("undefined"!==typeof a&&null!==a){var c=void 0;a=a.description;for(let d of b.endCell.neighbors)if(d.direction===
a){c=b.gameBoard.getCell(d.x,d.y);break}"undefined"===typeof c||null===c||c.wall||(c.start_cell?n("You ran into the enemy tank"):(z(),c.end_cell=!0,getCellElemFromCell(c).classList.add("end"),b.endCell=c,v(b.endCell),b.startLocated&&p(b.startCell),b.lastDirectionMoved=a))}c=b.firingQueue.dequeue();"undefined"!==typeof c&&null!==c&&f[" "]&&E();c=x();for(let d of c){if(c="move"===d.type&&r())a:{c=d.description;for(let e of b.endCell.neighbors)if(e.direction===c){c=b.gameBoard.getCell(e.x,e.y);if("undefined"===
typeof c||null===c)break;if(c.wall)break;c=!0;break a}c=!1}c&&b.movementQueue.enqueue(d);"fire"===d.type&&b.firingQueue.enqueue(d)}await sleep(100)}}async function C(){for(;!b.hasEnded&&!b.paused;)I(),await sleep(b.speed)}function I(){b.speed=Array.from(document.getElementById("difficulty").options).find(a=>a.selected).value;F()}function p(a){a.path=!0;0!==a.distance&&(a.start_cell||(getCellElem(a.x,a.y).classList.remove("visited"),getCellElem(a.x,a.y).classList.add("path")),p(a.getLowestDistanceNeighbor()))}
function v(a){const c=new Queue;a.visited=!0;for(c.enqueue(a);!c.isEmpty();){a=c.dequeue();if(a.start_cell)break;for(let d of a.neighbors.reverse()){let e=b.gameBoard.getCell(d.x,d.y);"NE"===d.direction&&t("N","E",a,"NE")?a.neighbors.splice(a.neighbors.indexOf(d),1):"SE"===d.direction&&t("S","E",a,"SE")?a.neighbors.splice(a.neighbors.indexOf(d),1):"SW"===d.direction&&t("S","W",a,"SW")?a.neighbors.splice(a.neighbors.indexOf(d),1):"NW"===d.direction&&t("N","W",a,"NW")?a.neighbors.splice(a.neighbors.indexOf(d),
1):(e.start_cell&&(b.startLocated=!0),e.distance>a.distance+d.connection_cost&&e.visited&&(e.distance=a.distance+d.connection_cost),e.visited||e.wall||(e.visited=!0,e.distance=a.distance+d.connection_cost,e.wall||c.enqueue(e)))}}}function t(a,c,d,e){let g=null,h=null,m=null;for(let l of d.neighbors)l.direction===a&&(g=b.gameBoard.getCell(l.x,l.y)),l.direction===c&&(h=b.gameBoard.getCell(l.x,l.y)),l.direction===e&&(m=b.gameBoard.getCell(l.x,l.y));return null===g||null===h||null===m?!1:g.wall&&h.wall?
!m.wall:!1}function J(a){b.hasStarted||b.gridBuilt||(a.target.classList.add("hidden"),k.disabled=!1,k.classList.remove("hidden"),a=Array.from(document.getElementById("mapSize").options).find(c=>c.selected).value,b.gameBoard.cols=a,b.gameBoard.rows=a,document.getElementById("mapSizeDropdown").classList.add("hidden"),document.getElementsByClassName("controls")[0].classList.add("hidden"),K(),b.gridBuilt=!0,document.getElementById("startMessage").classList.remove("hidden"),k.scrollIntoView({behavior:"smooth"}))}
function K(){for(let a=0;a<b.gameBoard.cols;a++){b.gameBoard.push([]);const c=document.createElement("div");c.id="col-"+a;c.classList.add("col");c.draggable=!1;c.ondragstart=function(){return!1};q.appendChild(c);for(let d=0;d<b.gameBoard.rows;d++){const e=new Cell(a,d,b);b.gameBoard.pushX(a,e);b.gameBoard.getCell(a,d).setNeighbors();const g=document.createElement("div");g.id=getCellId(a,d);g.classList.add("cell");g.classList.add("cell_hover");0!==a&&a!==b.gameBoard.cols-1&&0!==d&&d!==b.gameBoard.rows-
1||g.classList.add("edge");625>b.gameBoard.cols*b.gameBoard.rows?g.classList.add("large_cell"):1600>b.gameBoard.cols*b.gameBoard.rows?g.classList.add("medium_cell"):3600>b.gameBoard.cols*b.gameBoard.rows?g.classList.add("small_cell"):g.classList.add("x-small_cell");c.appendChild(g);g.addEventListener("mouseup",h=>e.handleClick(h));g.addEventListener("mouseover",B);g.addEventListener("mouseout",highlightCellRevert);g.draggable=!1;g.ondragstart=function(){return!1}}}}function B(a){b.settingStart?a.target.classList.add("startHighlight"):
b.settingEnd?a.target.classList.add("endHighlight"):b.settingWalls&&a.target.classList.add("wallHighlight")}function r(){const a=f.ArrowUp||f.w||f.W,c=f.ArrowDown||f.s||f.S,d=f.ArrowLeft||f.a||f.A,e=f.ArrowRight||f.d||f.D,g=f[" "];return a&&c||d&&e||!(a||c||d||e||g)?!1:!0}function x(){const a=f.ArrowUp||f.w||f.W,c=f.ArrowDown||f.s||f.S,d=f.ArrowLeft||f.a||f.A,e=f.ArrowRight||f.d||f.D,g=f[" "],h=[];a&&d?h.push(new GameEvent("move","NW")):a&&e?h.push(new GameEvent("move","NE")):c&&e?h.push(new GameEvent("move",
"SE")):c&&d?h.push(new GameEvent("move","SW")):c?h.push(new GameEvent("move","S")):a?h.push(new GameEvent("move","N")):d?h.push(new GameEvent("move","W")):e&&h.push(new GameEvent("move","E"));g&&h.push(new GameEvent("fire","playertank"));return h}function L(a){-1<"Space ArrowUp ArrowDown ArrowLeft ArrowRight M".split(" ").indexOf(a.code)&&a.preventDefault();if(b.hasStarted&&!b.hasEnded&&(f[a.key]=!0,!b.paused&&r())){" "!==a.key&&b.movementQueue.empty();a=x();for(let c of a)"move"===c.type&&b.movementQueue.enqueue(c)}}
function M(a){-1<"Space ArrowUp ArrowDown ArrowLeft ArrowRight M".split(" ").indexOf(a.code)&&a.preventDefault();if(b.hasStarted&&!b.hasEnded&&(f[a.key]=!1,!b.paused)){" "!==a.key&&"m"!==a.key?b.movementQueue.empty():" "===a.key?(E(),b.firingQueue.empty()):"m"===a.key&&N();a=x();for(let c of a)"move"===c.type&&r()?b.movementQueue.enqueue(c):"fire"===c.type&&r()&&b.firingQueue.enqueue(c)}}async function N(){if(!(!b.hasStarted||b.hasEnded||4<y)){y++;var a=b.endCell,c=getCellElemFromCell(a);c.classList.add("mine");
for(var d=0;8>d;){d++;await sleep(125);if(b.hasEnded)break;c.classList.add("mineFlash");await sleep(125);if(b.hasEnded)break;c.classList.remove("mineFlash")}if(b.hasEnded)c.classList.remove("mine"),c.classList.remove("mineFlash");else{for(let e of a.neighbors)d=b.gameBoard.getCell(e.x,e.y),d.start_cell?(document.getElementsByClassName("start")[0].classList.remove("start"),n("You blew up the enemy tank!")):getCellElemFromCell(d).classList.add("mineFlash");await sleep(125);for(let e of a.neighbors)a=
b.gameBoard.getCell(e.x,e.y),getCellElemFromCell(a).classList.remove("mineFlash");c.classList.remove("mine")}y--}}function O(){!b.hasEnded&&b.hasStarted&&(b.paused=!b.paused,b.paused?(b.movementQueue.empty(),b.firingQueue.empty(),document.getElementById("reload").classList.remove("notShown")):(C(),D(),document.getElementById("reload").classList.add("notShown")),w.textContent=b.paused?"Unpause":"Pause")}const b=new GameSession(150,30,30),q=document.getElementById("gameBoard_UI"),k=document.getElementById("start"),
w=document.getElementById("pause"),f={};let y=0;const P=()=>{const a=document.getElementById("ctrlList"),c=document.getElementById("hideBtn");a.classList.contains("hidden")?(a.classList.remove("hidden"),c.textContent="Hide"):(a.classList.add("hidden"),c.textContent="Show")};(function(){k.addEventListener("click",A);document.getElementById("buildGrid").addEventListener("click",J);w.addEventListener("click",O);document.getElementById("hideBtn").addEventListener("click",P);document.body.onmousedown=
u;document.body.onmousemove=u;document.body.onmouseup=u;document.addEventListener("keydown",L);document.addEventListener("keyup",M);k.disabled=!0;document.oncontextmenu=()=>!1;document.draggable=!1;document.ondragstart=function(){return!1};document.getElementById("difficulty").addEventListener("change",()=>{document.getElementById("difficulty").blur()});q.draggable=!1;q.ondragstart=function(){return!1}})()})();
